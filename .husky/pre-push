#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push quality gates..."
echo ""

# Run tests
echo "üìã Step 1: Running Tests"
echo "------------------------------------------------------------"
if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
  npm test || {
    echo ""
    echo "‚ùå Tests failed. Cannot push."
    echo "   Fix failing tests or use 'git push --no-verify' to skip (not recommended)"
    exit 1
  }
  echo "‚úÖ Tests passed"
  echo ""
else
  echo "‚ö†Ô∏è  No test script found. Skipping tests."
  echo ""
fi

# Run build
echo "üìã Step 2: Running Build"
echo "------------------------------------------------------------"
if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
  npm run build || {
    echo ""
    echo "‚ùå Build failed. Cannot push."
    echo "   Fix build errors or use 'git push --no-verify' to skip (not recommended)"
    exit 1
  }
  echo "‚úÖ Build successful"
  echo ""
else
  echo "‚ö†Ô∏è  No build script found. Skipping build."
  echo ""
fi

# Run CodeRabbit branch review
if command -v coderabbit &> /dev/null; then
  echo "üìã Step 3: CodeRabbit Branch Review"
  echo "------------------------------------------------------------"
  
  coderabbit review --branch || {
    echo ""
    echo "‚ö†Ô∏è  CodeRabbit found issues in branch."
    echo "   Review the issues before pushing."
    echo ""
    echo "Continue anyway? (y/n)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "Push cancelled."
      exit 1
    fi
  }
  
  echo "‚úÖ CodeRabbit branch review passed"
  echo ""
fi

echo "‚úÖ All pre-push checks passed!"
