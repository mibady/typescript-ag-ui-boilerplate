#!/bin/sh

echo "üöÄ Pre-push hook: Comprehensive validation"
echo "============================================================"

# Run tests (skip if test framework not installed yet)
if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
  echo ""
  echo "üß™ Running tests..."

  # Check if test command will work
  if npm test --dry-run 2>/dev/null; then
    npm test || {
      echo ""
      echo "‚ùå Tests failed - push aborted"
      echo "Fix tests or run: git push --no-verify"
      exit 1
    }
    echo "‚úÖ Tests passed"
  else
    echo "‚ö†Ô∏è  Test framework not installed yet - skipping tests"
    echo "   (Will be enforced after Phase 7: Testing & DevOps)"
  fi
fi

# Run build
if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
  echo ""
  echo "üî® Building project..."
  npm run build || {
    echo ""
    echo "‚ùå Build failed - push aborted"
    echo "Fix build or run: git push --no-verify"
    exit 1
  }
  echo "‚úÖ Build successful"
fi

# CodeRabbit branch review if available
if command -v coderabbit &> /dev/null; then
  echo ""
  echo "üê∞ CodeRabbit: Comprehensive branch review..."

  # Review entire branch against main
  coderabbit review --branch --compare main --format json > .coderabbit-branch-review.json 2>&1 || {
    echo "‚ö†Ô∏è  Branch review encountered issues (this is OK if not comparing to main)"
  }

  if [ -f ".coderabbit-branch-review.json" ]; then
    if grep -q '"severity": "blocker"' .coderabbit-branch-review.json 2>/dev/null; then
      echo ""
      echo "‚ùå BLOCKER ISSUES IN BRANCH"
      echo "============================================================"
      coderabbit review --branch --format pretty --filter blocker
      echo ""
      echo "Fix these critical issues before pushing!"
      rm -f .coderabbit-branch-review.json
      exit 1
    fi

    rm -f .coderabbit-branch-review.json
  fi

  echo "‚úÖ Branch review passed"
fi

# Check for sensitive data (basic check)
echo ""
echo "üîí Checking for sensitive data..."

if git diff --cached --name-only | xargs grep -l "api_key\|password\|secret\|token" 2>/dev/null | grep -v ".example" | grep -v "test"; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: Possible sensitive data detected!"
  echo "   Review the files above carefully"
  echo ""
  echo -n "Continue pushing? (y/N): "
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    exit 1
  fi
else
  echo "‚úÖ No obvious sensitive data detected"
fi

echo ""
echo "============================================================"
echo "‚úÖ Pre-push validation passed - OK to push"
echo "============================================================"
